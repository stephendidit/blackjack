<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Blackjack Attempt</title>
<!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" /> -->
<!-- <link rel="stylesheet" type="text/css" href="css/main.css" /> -->
</head>
<body>
<h3>Bugs:</h3>
<ol>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
</ol>
<div id="scores">
  <div id="wager"></div>
  <div id="purse"></div>
</div>

<!-- 
* 1. Build Deck // built as buildDeck()
* Create Dealer
* Create Player
* 2. Shuffle Deck // built as shuffle()
* 3. player Places Wager
  * wager = wager1
* 4. Deal one card to player (face up)
* 5. Deal one card to dealer (face down)
* 6. Deal one card to player (face up)
* 7. Deal one card to dealer (face up)

8. Dealer Hits Until Score of >= 17

Resolve Wagers
def resolve
  hands.each
    if hand == dealer
      push (player keeps original wager)
    else
      if hand <= 21
        if dealer > 21
          hand wins
        elsif hand > dealer
          hand wins
        elsif hand > player
          house wins
      elsif hand > 21
        house wins
      end
    end
  end
end

Discard Used Cards
Shuffle Remaining Cards and begin again -->

<div>
  <button id="hit" hidden>Hit</button>
  <button id="stay" hidden>Stay</button>
  <button id="double" hidden>Double</button>
  <button id="split" hidden>Split</button>
  <button id="drawpush" hidden>Draw/Push</button>
</div>

<script type="text/javascript" src="jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script> -->
<!-- <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script> -->
<!-- <script src="https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/js/bootstrap.js" crossorigin="anonymous"></script> -->
<!-- <script src="https://use.fontawesoplayer.com/343cc4bbfb.js"></script> -->
<script>




// GLOBAL //
var suitsArray = ['h','s','c','d'];
var valuesArray = [['a',1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],['j',10],['q',10],['k',10]];

function totalHand(hand){
  var totalValueOfHand = 0; // zero out the total
  var numberOfAcesInHand = 0; // zero out the number of aces...i think this is dealer's totaling, then.
  var CARD_VALUE_OFFSET = 1;
  
  hand.forEach(function(card){ // for each element in the dealer's hand
    if (card[CARD_VALUE_OFFSET] == 1) {
      numberOfAcesInHand += 1; // add 1 to the number of aces we're counting
    } else { // but if it's not an ace...
      totalValueOfHand += card[CARD_VALUE_OFFSET]; // then add the card to the total
    }
  });

  while (numberOfAcesInHand > 0){ // while there's more than 0 aces
    if ((totalValueOfHand + 11) > 21){ // if the total + 11 goes over 21
      totalValueOfHand +=1; // then the ace needs to be treated as a 1
    } else { // otherwise
      totalValueOfHand += 11; // treat it as an 11
    }
    numberOfAcesInHand--; // remove one ace from the count
  }

  return totalValueOfHand;
}

function countNumberOfPlayerHisHands(handsOfPlayer){
  return Object.keys(handsOfPlayer).length
}

function checkIfHandFirstMove(handCurrentlyBeingPlayed){
  if (handCurrentlyBeingPlayed.hand.length == 2){
    return true;
  } else {
    return false;
  }
}

function refreshPurse(){
  $('#purse').html("Purse: $" + player.purse);
}

// OBJECTS

function Game(){
  this.disableAllButtons = function(){
    $('button').hide();
  }
  this.showButtons = function(){
    $('button').off(); // http://stackoverflow.com/questions/14969960/jquery-click-events-firing-multiple-times
    var args = Array.prototype.slice.call(arguments);
    args.forEach(function (arg){
      $('#' + arg).show();
    });
  }
}

function Deck(){
  this.cards = [];

  this.build = function(requestedNumberOfDecks){
    var ValuesArrayFaceOffset = 0;
    var ValuesArrayFaceValueOffset = 1;
    var numberOfDecksBuilt = 0;
    var cardsArrayOffset = 0;
    var cardSuitAndCardValueOffset = 0;
    var cardValueOnlyOffset = 1;

    while (numberOfDecksBuilt < requestedNumberOfDecks){          
      suitsArray.forEach(function (suit){ // for each symbol
        valuesArray.forEach(function(value){ // for each value
          
          deck.cards[cardsArrayOffset] = []; // make an element that's also an array for the new card, in the position of the current index
          deck.cards[cardsArrayOffset][cardSuitAndCardValueOffset] = suit + value[ValuesArrayFaceOffset]; // the new element/array's first element = symbol + value[0]
          deck.cards[cardsArrayOffset][cardValueOnlyOffset] = value[ValuesArrayFaceValueOffset]; // the new element/array's second element = value[1]
          cardsArrayOffset++; // increase the index
        });
      });
      numberOfDecksBuilt++;
    }
  }; // end build

  this.shuffle = function(){ // https://github.com/coolaj86/knuth-shuffle , http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
  
    var currentIndex = this.cards.length, temporaryValue, randomIndex;
    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = this.cards[currentIndex];
      this.cards[currentIndex] = this.cards[randomIndex];
      this.cards[randomIndex] = temporaryValue;
    } // end while
  }; // end shuffle

  this.getNewCardFrom = function(){
    this.shuffle();
    return this.cards.pop();
  };
}

function Dealer(){
  this.hand = [];

  this.draw = function(){
    this.hand.push( deck.getNewCardFrom() );
  };

  this.play = function(){
    
    this.totalValueOfDealerHand = totalHand(this.hand); // who knows what this var is?
    console.info(this.totalValueOfDealerHand); // should begin as 0, i guess....
    while (this.totalValueOfDealerHand <= 17) { // if sometotal is less than 17...sometotal should be the more like dealer.total
      dealer.draw(); // draw again
      this.totalValueOfDealerHand = totalHand(this.hand); // and re-total the hand
    }
  };
}

function Player(){
  // this.hand = [];
  this.purse = 1000;
  this.wager = 25;

  $('#wager').html("Wager: $" + this.wager);
  $('#purse').html("Purse: $" + this.purse);

  this.hands = {
    1: {
      hand: [],
      played: false
    }
  };

  this.lose = function(){
    player.purse -= player.wager;
    refreshPurse();
  }

  this.win = function(){
    player.purse += player.wager;
    refreshPurse();
  }

  this.stay = function(handCurrentlyBeingPlayed){
    handCurrentlyBeingPlayed.played = true;
    player.play();
  }

  this.draw = function(whichHandNumber){
    console.log("about to draw card for hand " + whichHandNumber)
    var handToAddNewCardTo = this.hands[whichHandNumber]['hand']
    handToAddNewCardTo.push( deck.getNewCardFrom() );
  };

  this.hit = function(thisHandNumber,handCurrentlyBeingPlayed){
    player.draw(thisHandNumber); // grab a random card and add to current hand

    handCurrentlyBeingPlayed.totalValue = totalHand(handCurrentlyBeingPlayed.hand); // recalculate value

    if (handCurrentlyBeingPlayed.totalValue > 21){
      handCurrentlyBeingPlayed.played = true;
      
      this.lose();
      
      console.log("BUST!");

      game.disableAllButtons();
      // player.play();
    } else if (handCurrentlyBeingPlayed.totalValue == 21){
      handCurrentlyBeingPlayed.played = true;
      console.log("This is the best score you can get with this hand--so...moving on!")
      game.disableAllButtons();
    }

    // handCurrentlyBeingPlayed.totalValue = totalHand(handCurrentlyBeingPlayed.hand);

    // player.play();

    // console.log(player.hands);
  }

  this.split = function(){
    // console.log("---------------->\njust began player.split")
    var totalNumberOfPlayerHands = countNumberOfPlayerHisHands(this.hands); // gets "object of objects" length

    this.hands[totalNumberOfPlayerHands + 1] = {hand:[], played: false}; // new object assigned to next integer

    totalNumberOfPlayerHands = countNumberOfPlayerHisHands(this.hands); // gets "object of objects" length

    console.log("totalNumberOfPlayerHands = " + totalNumberOfPlayerHands);
  }

  this.setPlayActionButtons = function(isHandFirstMove){
    if (isHandFirstMove === true){
      game.disableAllButtons();
      game.showButtons("double","stay","hit","split");
      isHandFirstMove = false;
    } else {
      game.showButtons("stay","hit","split");
    }
  }

  this.isABlackjack = function(handCurrentlyBeingPlayed){
    if ( (Object.keys(handCurrentlyBeingPlayed.hand).length == 2) && handCurrentlyBeingPlayed.totalValue == 21) { 
      game.disableAllButtons();
      this.purse += (this.wager * 1.5);
      refreshPurse();
      return true;
    }
  }

  this.findFirstHandAvailableToPlay = function(){
    for (var thisHandNumber in this.hands){ 
      if (!this.hands[thisHandNumber].played){
        return thisHandNumber;
      } 
    }
    return false;
  }

  this.setCurrentHandValue = function(handCurrentlyBeingPlayed){
    handCurrentlyBeingPlayed.totalValue = totalHand(handCurrentlyBeingPlayed.hand);
  }


  this.play = function(){
    if (this.findFirstHandAvailableToPlay()) {
      var handCurrentlyBeingPlayed = this.hands[this.findFirstHandAvailableToPlay()];
      var thisHandNumber = this.findFirstHandAvailableToPlay();
      console.log(">>>>>>>>\nThere's a hand to play! HAND " + thisHandNumber + "\n<<<<<<<<");

      this.setCurrentHandValue(handCurrentlyBeingPlayed);

      if ( this.isABlackjack(handCurrentlyBeingPlayed) ) {
        handCurrentlyBeingPlayed['played'] = true;
      }
      
      this.setPlayActionButtons(checkIfHandFirstMove(handCurrentlyBeingPlayed));

    } else { 
      console.log("NO HANDS LEFT TO PLAY!")
    }
    
    $('#hit').click(function(){
      console.log("about to send thisHandNumber: " + thisHandNumber);
      // console.log("as well as handCurrentlyBeingPlayed: " + handCurrentlyBeingPlayed);
      player.hit(thisHandNumber,handCurrentlyBeingPlayed)

      handCurrentlyBeingPlayed.totalValue = totalHand(handCurrentlyBeingPlayed.hand);

      player.play();
      console.log(player.hands);
    });


    $('#split').click(function(){
      player.split();
    });

    $('#stay').click(function(){
      player.stay(handCurrentlyBeingPlayed);
      // handCurrentlyBeingPlayed.totalValue = totalHand(handCurrentlyBeingPlayed.hand);
      // console.log("post-move/inside while Hand value: " + handCurrentlyBeingPlayed.totalValue);
    });

  }
}
var howManyDecks = 1;


// TESTS
var game = new Game();
var deck = new Deck();
deck.build(howManyDecks);

// var dealer = new Dealer();

var player = new Player();

// dealer.draw(); 
player.draw(1);
// dealer.draw(); // this one would be face down 
player.draw(1);

player.play();

// dealer.play(); 

</script>




</body>
</html>